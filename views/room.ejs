<!DOCTYPE html>
<html lang="hu">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="output.css" />
    <title>Sakk - Játék</title>
  </head>
  <body class="min-h-screen bg-amber-100 flex">
    <div class="w-80 bg-white shadow-lg flex flex-col h-screen">
      <div class="bg-amber-600 text-white p-4">
        <h2 class="text-xl font-bold">Chat</h2>
        <p class="text-sm" id="room-info"></p>
      </div>

      <div
        id="chat-messages"
        class="flex-1 overflow-y-auto p-4 space-y-2 bg-amber-50"
      ></div>

      <div class="p-4 bg-white border-t border-gray-200">
        <div class="flex gap-2">
          <input
            id="chat-input"
            type="text"
            placeholder="Üzenet..."
            class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500"
          />
          <button
            id="send-btn"
            class="px-4 py-2 bg-amber-600 text-white rounded-lg font-semibold hover:bg-amber-700"
          >
            Küldés
          </button>
        </div>
      </div>
    </div>

    <div class="flex-1 flex items-center justify-center p-12">
      <div class="text-center">
        <h1 class="text-4xl font-bold text-amber-600 mb-4">Sakk Játék</h1>
        <div class="bg-orange-400/20 rounded-lg p-2">
          <div
            id="chess-board"
            class="grid grid-cols-8 gap-0 w-[64vh] h-[64vh] border-amber-800"
          ></div>
        </div>
        <button
          id="leave-game-btn"
          class="mt-6 px-6 py-3 bg-red-500 text-white rounded-lg font-semibold hover:bg-red-600"
        >
          Kilépés
        </button>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      const urlParams = new URLSearchParams(window.location.search);
      const username = urlParams.get("username");
      const roomName = urlParams.get("room");

      if (!username || !roomName) {
        window.location.href = "/";
      }

      document.getElementById(
        "room-info"
      ).textContent = `${username} - ${roomName}`;

      socket.emit("join-room", { nickname: username, room: roomName });

      function formatTime() {
        const now = new Date();
        return `${String(now.getHours()).padStart(2, "0")}:${String(
          now.getMinutes()
        ).padStart(2, "0")}`;
      }

      function addChatMessage(sender, message, isSystem = false) {
        const messagesDiv = document.getElementById("chat-messages");
        const messageDiv = document.createElement("div");

        if (isSystem) {
          messageDiv.className = "text-center text-gray-500 text-xs italic";
          messageDiv.textContent = message;
        } else {
          messageDiv.className = "text-sm";
          const time = formatTime();
          messageDiv.innerHTML = `
          <div class="bg-white rounded p-2 shadow-sm">
            <span class="text-gray-400 text-xs">${time}</span>
            <span class="font-semibold text-amber-600">${sender}</span>
            <span class="text-gray-700"> → ${message}</span>
          </div>
        `;
        }

        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      document.getElementById("send-btn").addEventListener("click", () => {
        const input = document.getElementById("chat-input");
        const message = input.value.trim();

        if (message) {
          socket.emit("send-message", {
            room: roomName,
            nickname: username,
            message,
          });
          input.value = "";
        }
      });

      document
        .getElementById("chat-input")
        .addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            document.getElementById("send-btn").click();
          }
        });

      document
        .getElementById("leave-game-btn")
        .addEventListener("click", () => {
          socket.emit("leave-room", { nickname: username, room: roomName });
          window.location.href = "/";
        });

      socket.on("new-message", (msg) => {
        addChatMessage(msg.sender, msg.text);
      });

      socket.on("system-message", (msg) => {
        addChatMessage("", msg, true);
      });

      for (let row = 0; row < 8; row++) {
        for (let col = 0; col < 8; col++) {
          const square = document.createElement("div");
          square.className =
            (row + col) % 2 === 0 ? "bg-amber-200" : "bg-amber-800";
          square.style.width = "70px";
          square.style.height = "70px";
          document.getElementById("chess-board").appendChild(square);
        }
      }
    </script>
  </body>
</html>
